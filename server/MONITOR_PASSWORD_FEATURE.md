# 监控密码功能说明

## 功能概述

每个考试可以设置一个独立的监控密码。使用监控密码登录后，可以查看该考试的实时监控信息，但没有管理权限。

## ✨ 统一登录入口

**系统首页现已整合为管理员和监考的统一登录入口！**

访问 `http://服务器IP:5000/`，可以：
- 输入**管理口令**（`gdufskaoshi`）→ 进入完整管理后台
- 输入**监控密码**（为考试设置的密码）→ 进入该考试的监控页面

系统会自动识别：
1. 先检查是否为管理口令
2. 如果不是，尝试验证监控密码
3. 监控密码匹配成功则直接跳转到对应考试的监控页面

## 使用流程

### 方式一：统一入口登录（推荐）

1. **访问系统首页**
   ```
   http://服务器IP:5000/
   ```

2. **输入密码**
   - 管理员：输入 `gdufskaoshi` → 进入管理后台
   - 监考员：输入考试的监控密码 → 进入监控页面

3. **自动跳转**
   - 系统自动识别并跳转到相应页面

### 方式二：直接监控登录（备用）

也可以访问专门的监控登录页面：
```
http://服务器IP:5000/monitor_login
```

仅用于输入监控密码，不支持管理口令。

### 1. 创建考试时设置监控密码

在创建考试或编辑考试时，可以设置"监控密码"字段（可选）：

- 如果设置了监控密码，外部人员可以使用该密码登录查看本场考试
- 如果留空，则该考试不支持监控密码登录

**💡 密码重复使用规则：**

监控密码只需在**时间重叠**的考试之间保持唯一。这意味着：

✅ **允许的情况：**
- 时间完全不重叠的考试可以使用相同密码
- 已结束的考试密码可以被新考试重复使用（如果时间不重叠）
- 不同时间段的考试可以使用相同密码

❌ **不允许的情况：**
- 两个时间重叠的考试不能使用相同密码（无论状态是 pending/active/completed）

**示例时间线：**
```
考试A: 09:00-11:00  密码: monitor123
考试B: 14:00-16:00  密码: monitor123  ← ✓ 允许（时间不重叠）
考试C: 14:00-16:00  密码: monitor123  ← ✗ 冲突！（与考试B时间重叠）
考试D: 15:00-17:00  密码: monitor123  ← ✗ 冲突！（与考试B、C时间重叠）
考试E: 19:00-21:00  密码: monitor123  ← ✓ 允许（时间不重叠）
```

**冲突检测：**
- 创建/编辑考试时，系统自动检查密码是否与时间重叠的其他考试冲突
- 使用时间重叠判断：`start_time < other_end_time AND end_time > other_start_time`
- 如有冲突，返回错误提示：`"监控密码冲突：考试'XXX'（时间段）与本场考试时间重叠，不能使用相同密码"`
- 需要选择其他密码或调整考试时间

### 2. 监控页面功能

监控页面 URL: `http://服务器IP:5000/monitor/<exam_id>`

**可用功能：**
- ✅ 查看考试基本信息（名称、时间、状态）
- ✅ 查看学生列表和在线状态
- ✅ 查看异常记录和截图
- ✅ 查看学生截图/录屏
- ✅ 自动刷新（每15秒）
- ✅ 新增异常提示

**禁用功能：**
- ❌ 创建/编辑/删除考试
- ❌ 导入/删除学生
- ❌ 删除异常记录
- ❌ 修改考试配置

## 数据库变更

新增字段：
```sql
ALTER TABLE exams ADD COLUMN monitor_password VARCHAR(255) DEFAULT NULL;
```

## API 接口

### POST /api/monitor/login

验证监控密码并返回考试ID

**请求：**
```json
{
  "monitor_password": "your_password"
}
```

**响应（成功）：**
```json
{
  "status": "success",
  "exam_id": 34,
  "exam_name": "期末考试"
}
```

**响应（失败）：**
```json
{
  "status": "error",
  "message": "密码错误或考试未在进行中"
}
```

## 文件清单

1. **数据库迁移：**
   - `add_monitor_password_field.py` - 添加字段脚本
   - `test_monitor_password.py` - 测试脚本

2. **前端页面：**
   - `templates/monitor_login.html` - 监控登录页面
   - `templates/monitor.html` - 简化版监控页面

3. **后端代码：**
   - `server.py` - 添加了3个路由：
     - `/monitor_login` - 监控登录页面
     - `/monitor/<exam_id>` - 监控页面
     - `/api/monitor/login` - 密码验证API
   - `data_access.py` - 修改了 `add_exam()` 方法

4. **前端修改：**
   - `templates/index.html` - 创建和编辑考试表单添加监控密码字段

## 安全说明

1. **密码存储：** 当前密码以明文存储在数据库中，适用于内部使用
2. **访问控制：** 只能查看状态为 'active' 的考试
3. **权限隔离：** 监控页面完全没有管理功能，只读访问

## 使用场景

1. **家长监控：** 家长使用监控密码查看孩子的考试状态
2. **外部监考：** 外部监考员无需管理员权限，只查看考场情况
3. **教师助手：** 助教查看考试进度，但不能修改配置
4. **演示展示：** 向外部人员展示系统功能，无泄露风险

## 测试步骤

1. 创建一个新考试，设置监控密码为 `test123`
2. 启动考试（status='active'）
3. 访问 `http://localhost:5000/monitor_login`
4. 输入密码 `test123`
5. 应自动跳转到该考试的监控页面
6. 验证只能查看，不能修改
